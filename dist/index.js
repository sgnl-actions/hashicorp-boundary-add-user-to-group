/**
 * @license MIT
 * Copyright (c) 2025 SGNL.ai, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";const t="SGNL-CAEP-Hub/2.0";class e extends Error{constructor(t){super(t),this.retryable=!0}}class o extends Error{constructor(t){super(t),this.retryable=!1}}var r={invoke:async(r,n)=>{console.log("Starting HashiCorp Boundary Add User to Group action");try{!function(t){if(!t.groupId||"string"!=typeof t.groupId||""===t.groupId.trim())throw new o("Invalid or missing groupId parameter");if(!t.userId||"string"!=typeof t.userId||""===t.userId.trim())throw new o("Invalid or missing userId parameter");if(!t.authMethodId||"string"!=typeof t.authMethodId||""===t.authMethodId.trim())throw new o("Invalid or missing authMethodId parameter")}(r);const{groupId:s,userId:a,authMethodId:i}=r;if(console.log(`Processing group ID: ${s}, user ID: ${a}`),!n.secrets?.BASIC_USERNAME||!n.secrets?.BASIC_PASSWORD)throw new o("Missing required secrets: BASIC_USERNAME and BASIC_PASSWORD");const u=function(t,e){const o=e.environment||{},r=t?.address||o.ADDRESS;if(!r)throw new Error("No URL specified. Provide address parameter or ADDRESS environment variable");return r.endsWith("/")?r.slice(0,-1):r}(r,n);console.log(`Authenticating with auth method: ${i}`);const d=await async function(r,n,s,a){const i=`${a}/v1/auth-methods/${encodeURIComponent(r)}:authenticate`,u=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":t},body:JSON.stringify({attributes:{login_name:n,password:s}})});if(!u.ok){const t=await u.text();if(429===u.status)throw new e("Boundary API rate limit exceeded");if(401===u.status||403===u.status)throw new o("Invalid username or password");if(u.status>=500)throw new e(`Boundary API server error: ${u.status}`);throw new o(`Failed to authenticate: ${u.status} ${u.statusText} - ${t}`)}const d=await u.json();if(!d.attributes?.token)throw new o("No token returned from authentication");return d.attributes.token}(i,n.secrets.BASIC_USERNAME,n.secrets.BASIC_PASSWORD,u);await new Promise(t=>setTimeout(t,100)),console.log(`Getting group details for: ${s}`);const c=await async function(r,n,s){const a=`${s}/v1/groups/${encodeURIComponent(r)}`,i=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json","User-Agent":t}});if(!i.ok){const t=await i.text();if(429===i.status)throw new e("Boundary API rate limit exceeded");if(401===i.status)throw new o("Invalid or expired authentication token");if(404===i.status)throw new o(`Group not found: ${r}`);if(i.status>=500)throw new e(`Boundary API server error: ${i.status}`);throw new o(`Failed to get group: ${i.status} ${i.statusText} - ${t}`)}const u=await i.json();if(!u.version)throw new o("No version returned from group");return u.version}(s,d,u);await new Promise(t=>setTimeout(t,100)),console.log(`Adding user ${a} to group ${s} with version: ${c}`),await async function(r,n,s,a,i){const u=`${i}/v1/groups/${encodeURIComponent(r)}:add-members`,d=await fetch(u,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json","User-Agent":t},body:JSON.stringify({version:s,member_ids:[n]})});if(!d.ok){const t=await d.text();if(429===d.status)throw new e("Boundary API rate limit exceeded");if(401===d.status)throw new o("Invalid or expired authentication token");if(404===d.status)throw new o(`Group or user not found: ${r} / ${n}`);if(409===d.status)throw new o(`Conflict (user may already be in group): ${t}`);if(d.status>=500)throw new e(`Boundary API server error: ${d.status}`);throw new o(`Failed to add user to group: ${d.status} ${d.statusText} - ${t}`)}return!0}(s,a,c,d,u);const h={groupId:s,userId:a,authMethodId:i,userAdded:!0,addedAt:(new Date).toISOString()};return console.log(`Successfully added user ${a} to group ${s}`),h}catch(t){if(console.error(`Error adding user to Boundary group: ${t.message}`),t instanceof e||t instanceof o)throw t;throw new o(`Unexpected error: ${t.message}`)}},error:async(t,e)=>{const{error:o}=t;throw console.error(`Error handler invoked: ${o?.message}`),o},halt:async(t,e)=>{const{reason:o,groupId:r,userId:n,authMethodId:s}=t;return console.log(`Job is being halted (${o})`),{groupId:r||"unknown",userId:n||"unknown",authMethodId:s||"unknown",reason:o||"unknown",haltedAt:(new Date).toISOString(),cleanupCompleted:!0}}};module.exports=r;
